import { OAuth2Client } from "oslo/oauth2";
import { TimeSpan, createDate } from "oslo";
export class Keycloak {
    client;
    realmURL;
    clientSecret;
    constructor(realmURL, clientId, clientSecret, redirectURI) {
        this.realmURL = realmURL;
        const authorizeEndpoint = this.realmURL + "/protocol/openid-connect/auth";
        const tokenEndpoint = this.realmURL + "/protocol/openid-connect/token";
        this.client = new OAuth2Client(clientId, authorizeEndpoint, tokenEndpoint, {
            redirectURI
        });
        this.clientSecret = clientSecret;
    }
    async createAuthorizationURL(state, codeVerifier, options) {
        const scopes = options?.scopes ?? [];
        return await this.client.createAuthorizationURL({
            state,
            codeVerifier,
            scopes: [...scopes, "openid"]
        });
    }
    async validateAuthorizationCode(code, codeVerifier) {
        const result = await this.client.validateAuthorizationCode(code, {
            codeVerifier,
            credentials: this.clientSecret
        });
        const tokens = {
            accessToken: result.access_token,
            accessTokenExpiresAt: createDate(new TimeSpan(result.expires_in, "s")),
            refreshToken: result.refresh_token,
            refreshTokenExpiresAt: createDate(new TimeSpan(result.refresh_expires_in, "s")),
            idToken: result.id_token
        };
        return tokens;
    }
    async refreshAccessToken(refreshToken) {
        const result = await this.client.refreshAccessToken(refreshToken, {
            credentials: this.clientSecret
        });
        const tokens = {
            accessToken: result.access_token,
            accessTokenExpiresAt: createDate(new TimeSpan(result.expires_in, "s")),
            refreshToken: result.refresh_token,
            refreshTokenExpiresAt: createDate(new TimeSpan(result.refresh_expires_in, "s")),
            idToken: result.id_token
        };
        return tokens;
    }
}
